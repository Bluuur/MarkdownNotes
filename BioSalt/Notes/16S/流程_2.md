# 16S 基础流程

[toc]

`wd`：`/data1/project/<NBioS-yyyy-xxxxx-name>/`

## 质控

![img](流程_2_img/webp.webp)

使用 FastQC 进行质量检测

```shell
fastqc reads/*.fastq -o basic/fastqc/ -t 0
multiqc basic/fastqc/* -o basic/fastqc/ # 合并报告
```

## QIIME2 分析

### 文件准备

#### manifest

对于多条数据的导入，需要编写 manifest 文件，指明 reads 的路径。

以 `*_1/2.fq` 结尾的序列可以使用以下脚本生成 manifest 文件。

```shell
./basic/script/manifestGen.sh
```

生成文件路径：`basic/qiime/manifest.txt`

#### metadata

从 SRA 数据库下载的序列，在下载 SraRunTable 后，可以使用以下脚本生成 metadata 文件。

```shell
Rscript ./basic/script/metadataGen.r
```

生成文件路径：`basic/qiime/metadata.tsv` 

<font face=楷体 color=red>修改脚本，metadata 文件命令规范</font>

### 数据导入

激活 qiime conda 环境^[1]^。

双端测序数据（Phred33）的导入：

```shell
qiime tools import \
    --type 'SampleData[PairedEndSequencesWithQuality]' \
    --input-path basic/qiime/manifest.txt \
    --output-path basic/qiime/paired-end-demux.qza \
    --input-format PairedEndFastqManifestPhred33
```

+ 参数
  + `type` 可以用 `qiime tools import --show-importable-types` 命令查看可导入的类型。
  + `--input-format ` 可是使用 `qiime tools import --show-importable-formats` 命令查看可导入的格式。

---

查看数据基本情况。

```shell
mkdir basic/qiime/view/
qiime demux summarize \
    --i-data basic/qiime/paired-end-demux.qza \
    --o-visualization basic/qiime/paired-end-demux.qzv
```

可视化：[QIIME 2 View](https://view.qiime2.org/)

### 降噪 & 合并双端序列

#### 降噪

```shell
nohup qiime dada2 denoise-paired --i-demultiplexed-seqs basic/qiime/paired-end-demux.qza --p-trunc-len-f 270 --p-trunc-len-r 250 --o-table basic/qiime/table.qza --o-representative-sequences basic/qiime/rep-seqs.qza --o-denoising-stats basic/qiime/denoising-stats.qza --p-n-threads 10 &
```

+ 参数
  + `--p-trunc-len-f` INTEGER 由于质量下降，前向读取序列应被截断的位置。这会截断输入序列的 3' 端，即最后几个循环测序的碱基。短于此值的读取将被丢弃。应用此参数后，前向和反向读取之间仍必须至少有 12 个核苷酸的重叠。如果提供 0，则不执行截断或长度过滤。[必需]
  + `--p-trunc-len-r` INTEGER 由于质量下降，反向读取序列应被截断的位置。这会截断输入序列的 3' 端，即最后几个循环测序的碱基。短于此值的读取将被丢弃。应用此参数后，前向和反向读取之间仍必须至少有 12 个核苷酸的重叠。如果提供 0，则不执行截断或长度过滤。[必需]
  + `--p-trim-left-f` INTEGER 由于质量较低，前向读取序列保留的长度。这会修剪输入序列的 5' 端，即最初几个循环测序的碱基。[默认：0]
  + `--p-trim-left-r` INTEGER 由于质量较低，反向读取序列保留的长度。这会修剪输入序列的 5' 端，即最初几个循环测序的碱基。[默认：0]

#### 查看降噪信息

可视化 denoising stats：[QIIME 2 View](https://view.qiime2.org/)，展示去除低质量序列、嵌合体、合并等后的序列数。**下载该页面的 metadata.tsv 文件，作为下一步的输入文件。**

```shell
qiime metadata tabulate \
    --m-input-file basic/qiime/denoising-stats.qza \
    --o-visualization basic/qiime/denoising-stats.qzv
```

#### Feature table

```shell
qiime feature-table summarize \
    --i-table basic/qiime/table.qza \
    --o-visualization basic/qiime/table.qzv \
    --m-sample-metadata-file basic/qiime/metadata.tsv
```

#### 代表序列统计

```shell
qiime feature-table tabulate-seqs \
    --i-data basic/qiime/rep-seqs.qza \
    --o-visualization basic/qiime/rep-seqs.qzv
```

### 比对数据库

通过比对已知分类学组成的参考数据库的序列，可以获知 feature table 的代表序列的物种注释情况。在 qiime2 通常可以使用已经搭建好的分类学分类器：silva132 和 Greengene 13_8 等。这里使用 silva 数据库进行物种注释。

```shell
# downlaod silva classifier data 
wget https://data.qiime2.org/2020.8/common/silva-138-99-nb-classifier.qza 
mv silva-138-99-nb-classifier.qza basic/qiime/
```

```shell
# annotation
qiime feature-classifier classify-sklearn \
	--i-classifier basic/qiime/silva-138-99-nb-classifier.qza \
	--i-reads basic/qiime/rep-seqs.qza \
	--o-classification basic/qiime/taxonomy-dada2-sliva.qza \
	--p-n-jobs -1 \
	--verbose

```

```shell
qiime metadata tabulate \
  --m-input-file basic/qiime/taxonomy-dada2-sliva.qza \
  --o-visualization basic/qiime/taxonomy-dada2-sliva.qzv
# 物种分类条形图
qiime taxa barplot \
  --i-table basic/qiime/table.qza \
  --i-taxonomy basic/qiime/taxonomy-dada2-sliva.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --o-visualization basic/qiime/taxa-bar-plots.qzv
```



### 建树

```shell
qiime phylogeny align-to-tree-mafft-fasttree \
      --i-sequences basic/qiime/rep-seqs.qza \
      --o-alignment basic/qiime/rep_seqs_aligned.qza \
      --o-masked-alignment basic/qiime/rep_seqs_masked.qza \
      --p-n-threads 20 \
      --o-tree basic/qiime/unrooted-tree.qza \
      --o-rooted-tree basic/qiime/rooted-tree.qza
```

### Alpha 多样性分析

```shell
# 计算多样性(包括所有常用的Alpha和Beta多样性方法)，输入有根树、Feature表、样本重采样深度
# 取样深度看table.qzv文件确定（一般为样本最小的sequence count，或覆盖绝大多数样品的sequence count）
qiime diversity core-metrics-phylogenetic \
  --i-phylogeny basic/qiime/rooted-tree.qza \
  --i-table basic/qiime/table.qza \
  --p-sampling-depth 55464 \
  --m-metadata-file basic/qiime/metadata.tsv \
  --output-dir basic/qiime/core-metrics-results

# 输出结果包括多种多样性结果，文件列表和解释如下：
# beta多样性bray_curtis距离矩阵 bray_curtis_distance_matrix.qza
# alpha多样性evenness(均匀度，考虑物种和丰度)指数 evenness_vector.qza
# alpha多样性faith_pd(考虑物种间进化关系)指数 faith_pd_vector.qza
# beta多样性jaccard距离矩阵 jaccard_distance_matrix.qza
# alpha多样性observed_otus(OTU数量)指数 observed_otus_vector.qza
# alpha多样性香农熵(考虑物种和丰度)指数 shannon_vector.qza
# beta多样性unweighted_unifrac距离矩阵，不考虑丰度 unweighted_unifrac_distance_matrix.qza
# beta多样性unweighted_unifrac距离矩阵，考虑丰度 weighted_unifrac_distance_matrix.qza

# 测试分类元数据(sample-metadata)列和alpha多样性数据之间的关联，输入多样性值、sample-medata，输出统计结果
# 统计faith_pd算法Alpha多样性组间差异是否显著
qiime diversity alpha-group-significance \
  --i-alpha-diversity basic/qiime/core-metrics-results/faith_pd_vector.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --o-visualization basic/qiime/core-metrics-results/faith-pd-group-significance.qzv
# 统计evenness组间差异是否显著
qiime diversity alpha-group-significance \
  --i-alpha-diversity basic/qiime/core-metrics-results/evenness_vector.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --o-visualization basic/qiime/core-metrics-results/evenness-group-significance.qzv
```



### Beta 多样性分析

```shell
# 按subject分组，统计unweighted_unifrace距离的组间是否有显著差异,其他的分组分析类似。
qiime diversity beta-group-significance \
  --i-distance-matrix basic/qiime/core-metrics-results/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --m-metadata-column subject \
  --o-visualization basic/qiime/core-metrics-results/unweighted-unifrac-subject-significance.qzv \
  --p-pairwise
# 可视化三维展示unweighted-unifrac的主坐标轴分析
qiime emperor plot \
  --i-pcoa basic/qiime/core-metrics-results/unweighted_unifrac_pcoa_results.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --p-custom-axes weight \
  --o-visualization basic/qiime/core-metrics-results/unweighted-unifrac-emperor-weight.qzv
# 可视化三维展示bray-curtis的主坐标轴分析
qiime emperor plot \
  --i-pcoa basic/qiime/core-metrics-results/unweighted_unifrac_pcoa_results.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --p-custom-axes height \
  --o-visualization basic/qiime/core-metrics-results/unweighted-unifrac-emperor-height.qzv
```



---

### 稀疏曲线

稀疏曲线可以了解测序深度与 ASV 的关系。

![image-20240416150132032](流程_2_img/image-20240416150132032.png)

```shell
# --p-max-depth一般取table.qzv文件Frequency per sample的中位数左右
qiime diversity alpha-rarefaction \
  --i-table basic/qiime/table.qza \
  --i-phylogeny basic/qiime/rooted-tree.qza \
  --p-max-depth 55000 \
  --m-metadata-file basic/qiime/metadata.tsv \
  --o-visualization basic/qiime/alpha-rarefaction.qzv
```

metadata 文件除了 sample-id 还需要包含一列或多列非数字列用来分类。

### 微生物群组成分析 (ANCOM)

[ANCOM](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4450248/pdf/MEHD-26-27663.pdf) 可用于比较微生物在组间差异的分析方法， 结果与 LEfSe 类似。该方法基于成分对数比的方法，即先对 count 数据进行对数转换，再通过简单的秩和检验（stats 包内的 aov, friedman.test, lme 等函数）进行比较，最后计算统计量 w。ANCOM 的结果用 W 值来衡量组间差异显著性。W 值越高代表该物种在组间的差异显著性越高。

```shell
# 按subject分组进行差异分析
qiime feature-table filter-samples \
  --i-table basic/qiime/table.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --p-where "subject='subject-1'" \
  --o-filtered-table basic/qiime/subject-1-table.qza
```

```shell
# add pseudocount for log transform
qiime composition add-pseudocount \
  --i-table basic/qiime/subject-1-table.qza \
  --o-composition-table basic/qiime/comp-subject-1-table.qza
```

```shell
# ANCOM 
qiime composition ancom \
  --i-table basic/qiime/comp-subject-1-table.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --m-metadata-column weight \
  --o-visualization basic/qiime/ancom-subject-1-weight.qzv
```

```shell
# 按种水平进行合并，统计各种的总reads
qiime taxa collapse \
  --i-table basic/qiime/subject-1-table.qza \
  --i-taxonomy basic/qiime/taxonomy-dada2-sliva.qza \
  --p-level 6 \
  --o-collapsed-table basic/qiime/subject-1-table-l6.qza
# add-pseudocount
qiime composition add-pseudocount \
  --i-table basic/qiime/subject-1-table-l6.qza \
  --o-composition-table basic/qiime/comp-subject-1-table-l6.qza
# subject-1 -->weight
qiime composition ancom \
  --i-table basic/qiime/comp-subject-1-table-l6.qza \
  --m-metadata-file basic/qiime/metadata.tsv \
  --m-metadata-column weight \
  --o-visualization basic/qiime/l6-ancom-subject-1-weight.qzv
```

### 结果导出

```shell
# representative sequences
qiime tools export \
   --input-path basic/qiime/rep-seqs.qza \
   --output-path basic/qiime/finalResult
```

```shell
# features table
qiime tools export \
   --input-path basic/qiime/table.qza \
   --output-path basic/qiime/finalResult
```

```shell
biom normalize-table \
    -i basic/qiime/finalResult/feature-table.biom \
    -r \
    -o basic/qiime/finalResult/feature-table-norm.biom
```

```shell
biom convert \
    -i basic/qiime/finalResult/feature-table-norm.biom \
    -o basic/qiime/finalResult/feature-table-norm.tsv \
    --to-tsv \
    --header-key taxonomy
```

### LEfSe^[2]^

LEfSe 是 LDA Effect Size 分析，其本质是一类判别分析。其结果一般配合进化分支图使用，也即是展示差异物种在进化上的关系。

**原理：**首先使用 non-parametric factorial Kruskal-Wallis (KW) sum-rank test（非参数因子克鲁斯卡尔 — 沃利斯和秩验检）检测具有显著丰度差异特征，并找到与丰度有显著性差异的类群。最后，LEfSe 采用线性判别分析（LDA）来估算每个组分（物种）丰度对差异效果影响的大小。

**进化分支图：**由内至外辐射的圆圈代表了由门至属（或种）的分类级别。在不同分类级别上的每一个小圆圈代表该水平下的一个分类，小圆圈直径大小与相对丰度大小呈正比。着色原则：无显著差异的物种统一着色为黄色，差异物种 Biomarker 跟随组进行着色，红色节点表示在红色组别中起到重要作用的微生物类群，绿色节点表示在绿色组别中起到重要作用的微生物类群，若图中某一组缺失，则表明此组中并无差异显著的物种，故此组缺失。图中英文字母表示的物种名称在右侧图例中进行展示。

### 安装 LEfSe

```shell
conda create -n lefse -c bioconda lefse -y
```

### LEfSe 分析

#### calculate relative-frequency

```shell
mkdir basic/qiime/collapse/
# calculate relative-frequency for the collapsed table (relative abundance instead of counts)
qiime feature-table relative-frequency \
    --i-table  basic/qiime/subject-1-table-l6.qza \
    --o-relative-frequency-table basic/qiime/collapse.frequency.table.qza 
```

#### export biom file

```shell
qiime tools export \
    --input-path basic/qiime/collapse.frequency.table.qza \
    --output-path basic/qiime/collapse/
```

#### convert biom to text file

```shell
biom convert \
    -i basic/qiime/collapse/feature-table.biom \
    -o basic/qiime/collapse/collapse.frequency.table.tsv \
    --header-key "taxonomy" \
    --to-tsv
```

#### filter tax

```shell
sed 's/;/\|/g' basic/qiime/collapse/collapse.frequency.table.tsv | \
    awk '{split($1, a, "|");if( a[6] != "__"){print $0}}' | \
    # sed 's/d\_\_Bacteria|//g' | \
    grep -vE "g__uncultured|d__Archaea|p__WPS-2|p__SAR324_clade|Constructed" | \
    sed 's/#OTU ID/Group/g;s/taxonomy//g' > basic/qiime/collapse/collapse.frequency.table.lefse.tsv
```

#### run LEfSe

```shell
conda activate lefse
# convert text file into lefse.input file 
lefse-format_input.py \
basic/qiime/collapse/collapse.frequency.table.lefse.tsv \
basic/qiime/collapse.frequency.table.lefse.in \
    -c 1 \
    -m f \
    -o 1000000
```

```shell
# run lefse
run_lefse.py \
    basic/qiime/collapse.frequency.table.lefse.in \
    basic/qiime/collapse.frequency.table.lefse.res 
    
    ####
run_lefse.py /users/zhangzd/data/16sPipeline/basic/qiime/finalResult/feature-table-norm.tsv
basic/qiime/collapse.frequency.table.lefse.res 
```

```shell
# select significant result Lefse
grep -E "HTN|Normal" \
        basic/qiime/collapse.frequency.table.lefse.res \
        > basic/qiime/collapse.frequency.table.lefse_signif.res
```

```shell
# plot lda 
lefse-plot_res.py \
    basic/qiime/collapse.frequency.table.lefse_signif.res \
    basic/qiime/lefse_final_lda.pdf \
    --format pdf \
    --autoscale 0
```

```shell
# plot cladogram 
lefse-plot_cladogram.py\
    basic/qiime/collapse.frequency.table.lefse_signif.res \
    basic/qiime/lefse_total_clado.pdf \
    --format pdf
```

## 功能预测



## Reference

[1] Bolyen E, Rideout JR, Dillon MR, Bokulich NA, Abnet CC, Al-Ghalith GA, Alexander H, Alm EJ, Arumugam M, Asnicar F, Bai Y, Bisanz JE, Bittinger K, Brejnrod A, Brislawn CJ, Brown CT, Callahan BJ, Caraballo-Rodríguez AM, Chase J, Cope EK, Da Silva R, Diener C, Dorrestein PC, Douglas GM, Durall DM, Duvallet C, Edwardson CF, Ernst M, Estaki M, Fouquier J, Gauglitz JM, Gibbons SM, Gibson DL, Gonzalez A, Gorlick K, Guo J, Hillmann B, Holmes S, Holste H, Huttenhower C, Huttley GA, Janssen S, Jarmusch AK, Jiang L, Kaehler BD, Kang KB, Keefe CR, Keim P, Kelley ST, Knights D, Koester I, Kosciolek T, Kreps J, Langille MGI, Lee J, Ley R, Liu YX, Loftfield E, Lozupone C, Maher M, Marotz C, Martin BD, McDonald D, McIver LJ, Melnik AV, Metcalf JL, Morgan SC, Morton JT, Naimey AT, Navas-Molina JA, Nothias LF, Orchanian SB, Pearson T, Peoples SL, Petras D, Preuss ML, Pruesse E, Rasmussen LB, Rivers A, Robeson MS, Rosenthal P, Segata N, Shaffer M, Shiffer A, Sinha R, Song SJ, Spear JR, Swafford AD, Thompson LR, Torres PJ, Trinh P, Tripathi A, Turnbaugh PJ, Ul-Hasan S, van der Hooft JJJ, Vargas F, Vázquez-Baeza Y, Vogtmann E, von Hippel M, Walters W, Wan Y, Wang M, Warren J, Weber KC, Williamson CHD, Willis AD, Xu ZZ, Zaneveld JR, Zhang Y, Zhu Q, Knight R, and Caporaso JG. 2019. Reproducible, interactive, scalable and extensible microbiome data science using QIIME 2. *Nature Biotechnology* 37: 852–857. https://doi.org/10.1038/s41587-019-0209-9

[2] Segata, N., Izard, J., Waldron, L., Gevers, D., Miropolsky, L., Garrett, W. S., & Huttenhower, C. (2011). Metagenomic biomarker discovery and explanation. *Genome biology*, *12*(6), R60. https://doi.org/10.1186/gb-2011-12-6-r60