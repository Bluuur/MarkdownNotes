# 16S 基础流程

[toc]

`wd`：`/data1/project/<NBioS-yyyy-xxxxx-name>/`

## 质量检测

使用 FastQC 进行质量检测

```shell
fastqc reads/*.fastq -o basic/fastqc/ -t 0
multiqc basic/fastqc/* -o basic/fastqc/ # 合并报告
```

## 数据分析

### 文件准备

#### manifest

```shell
./basic/script/manifestGen.sh
```

生成文件路径：`basic/qiime/manifest.txt`

#### metadata

```shell
Rscript ./basic/script/metadataGen.r
```

生成文件路径：`basic/qiime/metadata.tsv`

### 数据导入

在 conda 环境下，安装 qiime2。

```shell
qiime tools import \
    --type 'SampleData[PairedEndSequencesWithQuality]' \
    --input-path basic/qiime/manifest.txt \
    --output-path basic/qiime/paired-end-demux.qza \
    --input-format PairedEndFastqManifestPhred33
```

查看数据基本情况

```shell
qiime demux summarize \
    --i-data basic/qiime/paired-end-demux.qza \
    --o-visualization basic/qiime/paired-end-demux.qzv
```

可视化：[QIIME 2 View](https://view.qiime2.org/)

### 降噪 & 合并双端序列

#### 降噪

```shell
qiime dada2 denoise-paired \
    --i-demultiplexed-seqs basic/qiime/paired-end-demux.qza \
    --p-trim-left-f 0 \
    --p-trim-left-r 0 \
    --p-trunc-len-f 270 \
    --p-trunc-len-r 250 \
    --o-table basic/qiime/table.qza \
    --o-representative-sequences basic/qiime/rep-seqs.qza \
    --o-denoising-stats basic/qiime/denoising-stats.qza \
    --p-n-threads 0
```

#### 查看降噪信息

可视化 denoising stats：[QIIME 2 View](https://view.qiime2.org/)，展示去除低质量序列、嵌合体、合并等后的序列数。**下载该页面的 metadata.tsv 文件，作为下一步的输入文件。**

```shell
qiime metadata tabulate \
    --m-input-file basic/qiime/denoising-stats.qza \
    --o-visualization basic/qiime/denoising-stats.qzv
```

#### Feature table

由于自动生成的 metadata.tsv 文件与前面脚本产生的同名，这里将从网页下载的文件扩展名修改为 `.txt`。文件存放路径：`basic/qiime/metadata.txt`

```shell
qiime feature-table summarize \
    --i-table basic/qiime/table.qza \
    --o-visualization basic/qiime/table.qzv \
    --m-sample-metadata-file basic/qiime/metadata.txt
```

#### 代表序列统计

```shell
qiime feature-table tabulate-seqs \
    --i-data basic/qiime/rep-seqs.qza \
    --o-visualization basic/qiime/rep-seqs.qzv
```

## 物种注释

### 比对数据库

通过比对已知分类学组成的参考数据库的序列，可以获知 feature table 的代表序列的物种注释情况。在 qiime2 通常可以使用已经搭建好的分类学分类器：silva132 和 Greengene 13_8 等。这里使用 silva 数据库进行物种注释。

```shell
# downlaod silva classifier data 
wget https://data.qiime2.org/2020.8/common/silva-138-99-nb-classifier.qza 

mv silva-138-99-nb-classifier.qza basic/qiime/

# annotation
qiime feature-classifier classify-sklearn \
	--i-classifier basic/qiime/silva-138-99-nb-classifier.qza  \
	--i-reads basic/qiime/rep-seqs.qza \
	--o-classification basic/qiime/taxonomy-dada2-sliva.qza \
	--p-n-jobs 20 \
	--verbose \
	--output-dir 
```

### 过滤 ASV

#### 去除低出现率 ASV

根据 table 的结果设置过滤 threshold，阈值有 frequency 和 samples，即 ASV 在所有样本的总 reads 和出现在样本数目。计算平均采样深度（对所有 ASV 的 count 加和并求平均值），设置采样阈值后再乘以平均采样深度即获得 frequency 阈值，另外也可以设置 ASV 出现在多少样本内。

```shell
qiime feature-table filter-features \
   --i-table basic/qiime/table.qza \
   --p-min-frequency 10 \
   --p-min-samples 1 \
   --o-filtered-table basic/qiime/table_filter_low_freq.qza
```

#### 去除污染序列

16S 扩增子常见污染序列来自线粒体和叶绿体等 16S 序列，另外也存在一些未注释的序列，均需要去除。

```shell
qiime taxa filter-table \
   --i-table basic/qiime/table_filter_low_freq.qza \
   --i-taxonomy basic/qiime/taxonomy-dada2-sliva.qza \
   --p-exclude mitochondria,chloroplast \
   --o-filtered-table  basic/qiime/table_filter_low_freq_contam.qza 
```

#### 去除含 ASV 少的样本

经过上述处理后，某些样本含有较少的 ASV 总量，因此可以将其剔除。通常使用的 threshold 的范围是 1 000 - 4 000 reads。

```shell
# 统计每个样本的 ASV 数量
qiime feature-table summarize \
   --i-table  basic/qiime/table_filter_low_freq_contam.qza \
   --o-visualization  basic/qiime/table_filter_low_freq_contam_summary.qzv
# 移除样本
qiime feature-table filter-samples \
   --i-table   basic/qiime/table_filter_low_freq_contam.qza \
   --p-min-frequency 4000 \
   --o-filtered-table   basic/qiime/final_table.qza 
# 代表序列
qiime feature-table filter-seqs \
   --i-data  basic/qiime/rep-seqs.qza \
   --i-table  basic/qiime/final_table.qza \
   --o-filtered-data basic/qiime/final_rep_seqs.qza
# 重新注释
qiime feature-classifier classify-sklearn \
   --i-classifier basic/qiime/silva-138-99-nb-classifier.qza  \
   --i-reads basic/qiime/final_rep_seqs.qza \
   --o-classification basic/qiime/final_taxonomy_sliva.qza \
   --p-n-jobs 20 \
   --verbose \
   --output-dir basic/qiime/reanno
# core features
qiime feature-table core-features \
   --i-table basic/qiime/final_table.qza \
   --p-min-fraction 0.6 \
   --p-max-fraction 1 \
   --p-steps 11 \
   --o-visualization basic/qiime/final_table_cores.qzv \
   --output-dir basic/qiime/coreFeat
```

## 下游分析

### 建树

```shell
qiime phylogeny align-to-tree-mafft-fasttree \
      --i-sequences basic/qiime/final_rep_seqs.qza \
      --o-alignment basic/qiime/final_rep_seqs_aligned.qza \
      --o-masked-alignment basic/qiime/final_rep_seqs_masked.qza \
      --p-n-threads 20 \
      --o-tree basic/qiime/unrooted-tree.qza \
      --o-rooted-tree basic/qiime/rooted-tree.qza
```

### 稀疏曲线

稀疏曲线可以了解测序深度与 ASV 的关系。

```shell
qiime diversity alpha-rarefaction \
     --i-table basic/qiime/final_table.qza \
     --i-phylogeny basic/qiime/rooted-tree.qza \
#      --p-max-depth 60000 \
     --m-metadata-file sample-metadata.txt \
     --o-visualization basic/qiime/p-max-depth-60000-alpha-rarefaction.qzv
```



## $\alpha$​ 多样性

## $\beta$​ 多样性

Simpson's diversity index 用于计算物种丰富度和相对丰度（alpha 多样性），而 Simpson similarity index 或 Simpson similarity index 用于计算不同的取样单位内的物种相似性 (beta 多样性）。

## 差异分析

## 功能预测
